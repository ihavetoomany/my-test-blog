---
import Layout from '../../layouts/Layout.astro';
import { getSupabase } from '../../lib/supabase';

let message = Astro.url.searchParams.get('message') ?? null;
let error = Astro.url.searchParams.get('error') ?? null;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const title = (formData.get('title') as string)?.trim();
    const content = (formData.get('content') as string)?.trim();
    const slug = (formData.get('slug') as string)?.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '') || null;
    const imageUrl = (formData.get('image_url') as string)?.trim() || null;

    if (!title || !content || !slug) {
      return Astro.redirect('/admin?error=' + encodeURIComponent('Title, content, and slug are required.'));
    }

    const supabase = getSupabase();
    const { error: insertError } = await supabase.from('posts').insert({
      title,
      content,
      slug,
      image_url: imageUrl || null,
    });

    if (insertError) {
      return Astro.redirect('/admin?error=' + encodeURIComponent(insertError.message));
    }
    return Astro.redirect('/admin?message=' + encodeURIComponent('Post created.'));
  } catch (e) {
    const err = e instanceof Error ? e.message : 'Something went wrong.';
    return Astro.redirect('/admin?error=' + encodeURIComponent(err));
  }
}
---

<Layout>
  <main class="min-h-screen bg-background text-foreground p-8 max-w-2xl mx-auto">
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Admin – New Post</h1>
      <a href="/" class="text-sm text-muted-foreground hover:text-foreground underline">← Back to blog</a>
    </div>

    {message && (
      <p class="mb-4 p-3 rounded-md bg-green-500/10 text-green-600 dark:text-green-400 border border-green-500/20" role="status">
        {message}
      </p>
    )}
    {error && (
      <p class="mb-4 p-3 rounded-md bg-destructive/10 text-destructive border border-destructive/20" role="alert">
        {error}
      </p>
    )}

    <form method="post" class="space-y-4">
      <div>
        <label for="title" class="block text-sm font-medium mb-1.5">Title</label>
        <input
          type="text"
          id="title"
          name="title"
          required
          class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
          placeholder="Post title"
        />
      </div>
      <div>
        <label for="slug" class="block text-sm font-medium mb-1.5">Slug (URL-friendly, e.g. my-first-post)</label>
        <input
          type="text"
          id="slug"
          name="slug"
          required
          class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
          placeholder="my-first-post"
        />
      </div>
      <div>
        <label for="content" class="block text-sm font-medium mb-1.5">Content</label>
        <textarea
          id="content"
          name="content"
          required
          rows={8}
          class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 resize-y"
          placeholder="Write your post..."
        />
      </div>
      <div>
        <label for="image_url" class="block text-sm font-medium mb-1.5">Image URL (optional)</label>
        <input
          type="url"
          id="image_url"
          name="image_url"
          class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
          placeholder="https://..."
        />
      </div>
      <button
        type="submit"
        class="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
      >
        Create post
      </button>
    </form>
  </main>
</Layout>
