---
import Layout from '../layouts/Layout.astro';
import { getSupabase } from '../lib/supabase';

let posts: Array<{ id: string; title: string; slug: string; created_at: string }> = [];
let loadError: string | null = null;
try {
  const supabase = getSupabase();
  const { data = [], error } = await supabase
    .from('posts')
    .select('id, title, slug, created_at')
    .order('created_at', { ascending: false });
  if (error) loadError = error.message;
  else posts = data;
} catch (e) {
  loadError = e instanceof Error ? e.message : 'Failed to load posts.';
}
---

<Layout>
  <main class="min-h-screen bg-background text-foreground p-8 max-w-2xl mx-auto">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-semibold">Test Blog</h1>
      <a href="/admin" class="text-sm text-muted-foreground hover:text-foreground underline">Admin</a>
    </div>
    <p class="mb-6 text-muted-foreground">Astro + Tailwind + shadcn/ui + Supabase.</p>

    <section>
      <h2 class="text-lg font-medium mb-3">Posts</h2>
      {loadError && (
        <p class="mb-4 p-3 rounded-md bg-destructive/10 text-destructive border border-destructive/20 text-sm" role="alert">
          {loadError}
          {loadError.includes('SUPABASE') && (
            <span class="block mt-1">Add SUPABASE_URL and SUPABASE_ANON_KEY in Vercel → Project → Settings → Environment Variables, then redeploy.</span>
          )}
        </p>
      )}
      {posts.length === 0 && !loadError ? (
        <p class="text-muted-foreground">No posts yet. <a href="/admin" class="underline">Create one</a>.</p>
      ) : posts.length > 0 ? (
        <ul class="space-y-2">
          {posts.map((post) => (
            <li>
              <a href={`/posts/${post.slug}`} class="text-foreground hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded">
                {post.title}
              </a>
            </li>
          ))}
        </ul>
      ) : null}
    </section>
  </main>
</Layout>
